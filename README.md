# Analysis of T Cell Populations in Blood and Cerebrospinal Fluid during Latent HIV-1 Infection 
This repository is for Problem Set 8 to replicate the figures, analyses, and scripts accompanying the final paper for 20.440. The content contained in this repository make up the majority of the supplementary figures, as they deal with imputation method comparisons as well as biomarker analysis and immune cell cluster compositions.

## Purpose 
Human immunodeficiency virus (HIV)-associated neurological disorders (HAND) such as dementia, myelopathy, and sensory neuropathies are well-documented, but molecular mechanisms underlying their onset is not fully understood. Understanding sources of potential neural degeneration caused by aberrant immune activation could allow for development of therapies/strategies to reduce HAND. To understand the populations of immune cells that are activated in HIV+ vs. HIV- patients, single cell RNA-seq (scRNA-seq) datasets were processed and genes with zero expression values were imputed. Two figures were created surrounding this preprocessing and imputation: the first, a visualization of biomarkers superimposed on the imputed data from one imputation method, called MAGIC<sup>1</sup>; the second, a comparison of multiple imputation methods along with the effects of the imputation on the immune cell cluster compositions, as annotated with Seurat<sup>2</sup>.

## To Reproduce the Analysis
### Directory Structure
The structure of this repository is based off of Claire Duvallet's Aerodigestion Aspiration Analysis public [repository](https://github.com/cduvallet/aspiration-analysis-public/blob/master/README.md). 

``` 
|-- README.md
|
|-- data
|    |-- raw_data: raw data from GEO, Farhadian 2018
|    |-- imputation_intermediate
|    |    |-- different_imputations 
|    |    |     |-- SAVER and scImpute final files 
|    |    |     |-- scimpute_intermediates: intermediate files created running scImpute
|    |    |-- magic_all_samples: files after MAGIC imputation was run on them
|    |    |-- filtered_data: data for all samples after preprocessing completed
|    |-- seurat_tables: original and imputed tables to create supplementary figures 2C, 2D
|
|-- output
|    |-- figures: png files used to assemble final figures
|    
|-- src
|    |-- processing_and_imputation: notebooks and scripts required to process and impute the files
|    |-- figure_making: jupyter notebooks and scripts to create supplementary figures 1 and 2
```

### Scripts to Reproduce
The scripts and notebooks can be run in any order as they are all self-contained. However, the Juptyer Notebooks are efficient and will run in under an hour, while the R scripts can take hours to run. We recommend using the final outputs of the R scripts instead of running them yourself.

#### Reproducing Processing and Imputation
##### magic_imputation.ipynb
To rerun MAGIC imputation and filtering of the data, the `magic_imputation.ipynb` notebook in the `src/processing_and_imputation` folder can be run. This notebook will preprocess the data according to the preprocessing steps outlined below in Methods and then perform MAGIC on the samples as outlined below in the imputation sections of the methods. The output to this notebook will appear in `data/imputation_intermediate/filtered_data` for the preprocessing steps and `data/imputation_intermediate/magic_all_samples` for the MAGIC steps, although these folders are already pre-populated for convenience.

##### imputation_scimpute_saver.R
To rerun scImpute and SAVER imputation of the filtered data, the `imputation_scimpute_saver.R` script in the `src/processing_and_imputation` folder can be run. This script will perform scImpute and SAVER on the samples as outlined below in the imputation sections of the methods. The output to this notebook will appear in `data/imputation_intermediate/different_imputations` for the final results of the scImpute and SAVER steps and `data/imputation_intermediate/different_imputations/scimpute_intermediates` for the intermediate scImpute steps, although these folders are already pre-populated.

##### Seurat_impute_non_impute.R
To rerun Seurat clustering anc cell composition analysis, the `Seurat_impute_non_impute.R` script in the  `src/processing_and_imputation` folder can be run. This script will perform Seurat clustering on the immune cells for each samples. The output to this notebook will appear in the `data/seurat_tables` folder for the tables generated by Seurat of the different cell cluster compositions, although these folders are already pre-populated. However, the user must have a copy of the .RData workspace that includes the integrated Seurat workspace. This was not uploadable to GitHub in a raw, compressed, or trimmed-down form due to the sheer size (~5GB) of the file. That is why the tables are already prepopulated so that the figures can be created without this file. However, if you really want to use the raw data, the file is available at [this DropBox link](https://www.dropbox.com/s/ti3pevr0e6g79bm/integratedDataFinal.RData?dl=0). 

#### Reproducing Figures
##### Supplementary Figure 1
To regenerate Supplementary Figure 1 to visualize biomarkers on the MAGIC-imputed data, the `supp_figure_1_magic_biomarkers.ipynb` in the `src/figure_making` folder can be run. This script will run a t-SNE on a representative sample imputed by MAGIC and superimpose the t-SNE plots with 9 biomarkers identified in Farhadian 2018. The output to this notebook will appear in the `src/output/figures` folder, although this folder is prepopulated.

##### Supplementary Figure 2A,2B
To regenerate Supplementary Figure 2 A and B to visualize comparisons of the imputation methods, the `supp_figure_2AB_imputation_comparison.ipynb` in the `src/figure_making` folder can be run. This script will run PCA and t-SNEs on all three imputation methods and the raw filtered data to visualize the effects of different imputations. The output to this notebook will appear in the `src/output/figures` folder, although this folder is prepopulated.

##### Supplementary Figure 2C,2D
To regenerate Supplementary Figure 2 C and D to visualize different compositions of the immune cells before and after MAGIC imputation, the `supp_figure_2CD_barplots.R` in the `src/figure_making` folder can be run. This script will run Seurat-facilitated cell clustering and composition analysis on a per-sample basis for the non-imputed data and the MAGIC-imputed data to visualize the effects of MAGIC. This file utilizes the Seurat-generated tables in `data/seurat_tables`. The output to this notebook will appear in the `src/output/figures` folder, although this folder is prepopulated.

#### Final Integrated Figures
Please note that since scripts in both Python and R were used to make parts of Supplementary Figure 2, the stitching of these components were done outside of either Python or R scripts. The final integrated supplementary figure 2 is included in the `src/output/figures` folder.

### Installation Requirements
#### Python Requirements
You will need Python v.3.7.1, although some packages may have backwards compatibility. Python analyses require the following packages: magic v.1.5.3, scprep v.0.11.1, matplotlib v.3.0.3, numpy v.1.15.4, pandas v.0.23.4, csv v.1.0, and sklearn v.0.20.1. MAGIC was installed according to the [Krishnaswamy Lab Protocol](https://github.com/KrishnaswamyLab/MAGIC) for installation.

#### R Requirements
You will also need R v.3.5.1, although again some packages may have backwards compatibility. R analyses require the following packages: scImpute v.0.0.9, SAVER v.1.1.1, doSNOW v.1.0.16, doParallel v.1.0.14, Seurat v.3.0.0., ggpubr v.0.2, RColorBrewer v.1.1.2, ggplot2 v.2.3.1.1, topGO v.2.34.0, dplyr v.0.8.0.1, MAST v.1.8.2, and Rmagic v.1.5.0. In the R scripts, the installation lines are commented out but can easily be added depending on the packages your machine already has installed. Seurat was installed according to the [Satija Lab Protocol](https://satijalab.org/seurat/install.html) for installation.

## Information about the Code
### Data Sources
To understand the characteristic gene expression features of HIV+ and HIV- patients, single cell RNA sequencing (scRNA-seq) data of blood and cerebrospinal fluid (CSF) cells were obtained using SeqWell methodology<sup>3</sup>.  Datasets from [Farhadian, et. al](https://insight.jci.org/articles/view/121718). included CSF scRNA-seq data from 3 HIV+ and 2 HIV- patients; for 2 of the HIV+ patients, matched blood scRNA-seq data was included. The patients were males between the ages of 33 and 59, with varied histories of substance use, alcohol use, and smoking, matched between the patient and control populations. This data is also available on GEO associated with the ID [GEO177397](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE117397).

### Methods
#### Preprocessing
Several preprocessing steps were utilized via scprep before imputing the data. First, empty columns and rows were removed from the expression matrix. Any cells that expressed less than 500 genes were retained for the analysis, as this step is standard to remove low-quality cells. Genes expressed in less than 3 cells were filtered out to remove extremely rare genes that might confound the analysis, again as is standard in the field. The gene expression matrix was normalized by library size via L1 normalization, meaning each cell was rescaled so that the sum of expression values for each cell sums to 1. This rescales the data as if each cell was sampled evenly. Finally, data was transformed by taking the square root of each element in the gene expression matrix.

#### Imputation with SAVER, scImpute, and MAGIC
To decrease the sparsity of the gene expression matrix prior to downstream analyses, several imputation-based techniques have been published that uncover likely values for dropout genes. Three methods, SAVER<sup>4</sup>, scImpute<sup>5</sup>, and MAGIC<sup>1</sup>, were compared. MAGIC was used with the default settings, using the built-in MAGIC principal component analysis (PCA) and t-distributed stochastic neighborhood embedding (t-SNE) functions to visualize the results, again with the default settings (decay = 15, k nearest neighbors = 5, distance = Euclidean, number of principal components = 100, time step t = 10). scImpute was used with an estimation of 20 clusters, as Farhadian 2018 identified 14 clusters but with some clusters rather large and heterogeneous, we felt it might be too restrictive to use only 14. 20 was chosen because this would ensure that we at least capture the original clusters as well as possibly split the one mixed population and the four large T cell clusters. All other default settings were utilized (labeled cells = False, dropout threshold = 0.5). SAVER was run with the default settings and the computation was parallelized with the doParallel function on six cores to match the number on the server used. To visualize scImpute, SAVER, and raw results with PCA and t-SNE, the sklearn functions were used with default settings.

#### Seurat Clustering
A few preprocessing steps were performed in Seurat prior to the intermediate file used in the `supp_figure_2CD_Seurat_impute_non_impute.R` analysis. The files for each sample were read in and used to create Seurat objects, which were then all integrated into one Seurat object for the cell cluster composition analysis. Markers were computed for each cell cluster by Seurat and the cell clusters were manually renamed according to these markers. A stacked barplot was created for each sample's cell cluster composition and scaled to percentages rather than raw cell numbers. Then, MAGIC imputation was performed in R with Rmagic on the Seurat object itself according to the same parameters used with the Python version of R. Seurat was again used to find clusters and identify the analogous cluster from the non-imputed dataset. A similar stacked barplot was generated to visualize the relative changes in cell cluster composition after imputation.

## References
1. van Dijk, D, Sharma, R, Nainys, J, et al. Recovering gene interactions from single-cell data using data diffusion. Cell. 2018; 174(3): 716-729. doi: 10.1016/j.cell.2018.05.061.  

2. Butler, A, Hoffman, P, Smibert, P, Papalexi, E, Satija, R. Integrating single-cell transcriptomic data across different conditions, technologies, and species. Nature Biotechnology. 2018; 36: 411-420. doi:10.1038/nbt.4096.

2. Farhadian, SF, Mehta, SS, Zografou, C. Single-cell RNA sequencing reveals microglia-like cells in cerebrospinal fluid during virologically suppressed HIV. JCI Insight. 2018; 3(18): 121718. doi: 10.1172/jci.insight.121718.

3. Huang, M, Wang, J, Torre, E, et al. SAVER: gene expression recovery for single-cell RNA sequencing. Nat Methods. 2018; 15: 539-542. doi: 10.1038/s41592-018-0033-z.

4. Li, WV, Li, JJ. An accurate and robust imputation method scImpute for single-cell RNA-seq data. Nat Communications. 2018; 9(997). doi: 10.1038/s41467-018-03405-7.

